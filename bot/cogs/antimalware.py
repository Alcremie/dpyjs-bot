"""Antimalware."""

import discord
import textwrap

from discord.ext import commands
from bot.bot import Bot

TXT_FILE_MESSAGE = "{}, it seems that your message got zapped by our spam filter! We recommend you to shorten your message."
PY_JS_FILE_MESSAGE = "{}, it seems that you posted a Python or a JavaScript file! These files are not allowed here. We recommend you to use a code-pasting service such as [Pastebin](https://pastebin.com/) or [Hastebin](https://hastebin.com/)."
OTHER_FILE_MESSAGE = "{}, that file type is not allowed on our community."

class AntimalwareCog(commands.Cog):
    """Antimalware cog. Contains filters."""

    def __init__(self, bot: Bot) -> None:
        """Takes a parameter that must be an instance of bot.bot.Bot (see /bot/bot.py)."""

        self.bot = bot

    @commands.Cog.listener()
    async def on_message(self, message: discord.Message) -> None:

        if not message.attachments or not message.guild: return

        # Check for illegal extensions.
        for attachment in message.attachments:
            if not attachment.url.endswith(tuple(self.bot.constants["server"]["valid-file-extensions"])):
                invalid_file = attachment.url
                break
        else:
            return

        await message.delete()

        if invalid_file.endswith(("py", "js")):
            embed: discord.Embed = discord.Embed(
                description=PY_JS_FILE_MESSAGE.format(message.author.mention),
                color=self.bot.constants["style"]["colors"]["normal"]
            )
            await message.channel.send(embed=embed)

        elif invalid_file.endswith("txt"):
            embed: discord.Embed = discord.Embed(
                description=TXT_FILE_MESSAGE.format(message.author.mention),
                color=self.bot.constants["style"]["colors"]["normal"]
            )
            await message.channel.send(embed=embed)

        else:
            embed: discord.Embed = discord.Embed(
                description=OTHER_FILE_MESSAGE.format(message.author.mention),
                color=self.bot.constants["style"]["colors"]["normal"]
            )
            await message.channel.send(embed=embed)

def setup(bot: Bot) -> None:
    bot.add_cog(AntimalwareCog(bot))
